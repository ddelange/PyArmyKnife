name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7]
    steps:
    - uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      env:
        # PIP_INDEX_URL: https://${{ secrets.PYPI_USER }}:${{ secrets.PYPI_PASSWORD }}@custom_pypi_url/simple
        PIP_EXTRA_INDEX_URL: https://pypi.org/simple/
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/ci.txt
        pip install .
        pip install codecov

    - name: Lint
      run: make lint

    - name: Test
      run: make test

    - name: Codecov
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      run: codecov

    # - name: PyPi Deploy preparation
    #   if: startsWith(github.ref, 'refs/tags/')
    #   run: |
    #     pip install --upgrade setuptools wheel
    #     python setup.py sdist bdist_wheel

    # - name: PyPi Deploy
    #   uses: pypa/gh-action-pypi-publish@v1.0.0a0
    #   if: startsWith(github.ref, 'refs/tags/')
    #   with:
    #     user: ${{ secrets.PYPI_USER }}
    #     password: ${{ secrets.PYPI_PASSWORD }}
    #     # repository_url: custom_pypi_url
